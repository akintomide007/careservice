generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-Tenant: Organization Model
model Organization {
  id                String              @id @default(uuid())
  name              String
  subdomain         String              @unique
  domain            String?
  logo              String?
  primaryColor      String?             @default("#3B82F6")
  isActive          Boolean             @default(true) @map("is_active")
  plan              String              @default("basic")
  maxUsers          Int                 @default(50) @map("max_users")
  maxClients        Int                 @default(100) @map("max_clients")
  billingStatus     String              @default("active") @map("billing_status") // 'active', 'suspended', 'cancelled'
  billingEmail      String?             @map("billing_email")
  subscriptionStart DateTime?           @map("subscription_start")
  subscriptionEnd   DateTime?           @map("subscription_end")
  lastActivityAt    DateTime?           @map("last_activity_at")
  totalUsers        Int                 @default(0) @map("total_users")
  totalClients      Int                 @default(0) @map("total_clients")
  storageUsedMB     Int                 @default(0) @map("storage_used_mb")
  settings          Json?
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  
  users             User[]
  clients           Client[]
  formTemplates     FormTemplate[]
  auditLogs         AuditLog[]
  supportTickets    SupportTicket[]
  usageMetrics      UsageMetric[]
  notifications     Notification[]
  organizationSettings OrganizationSettings?

  @@map("organizations")
}

// Extended Organization Settings for Multi-Tenant Customization
model OrganizationSettings {
  id                String        @id @default(uuid())
  organizationId    String        @unique @map("organization_id")
  
  // Branding & Visual Identity
  logoUrl           String?       @map("logo_url")
  printLogoUrl      String?       @map("print_logo_url")
  faviconUrl        String?       @map("favicon_url")
  primaryColor      String        @default("#3B82F6") @map("primary_color")
  secondaryColor    String        @default("#10B981") @map("secondary_color")
  accentColor       String        @default("#8B5CF6") @map("accent_color")
  fontFamily        String        @default("Inter") @map("font_family")
  
  // Company Information
  companyName       String        @map("company_name")
  tagline           String?
  addressLine1      String?       @map("address_line1")
  addressLine2      String?       @map("address_line2")
  city              String?
  state             String?
  zipCode           String?       @map("zip_code")
  phone             String?
  email             String?
  website           String?
  
  // Feature Toggles
  enabledModules    Json          @default("[]") @map("enabled_modules") // Array of enabled module names
  
  // Customization
  dashboardLayout   Json?         @map("dashboard_layout") // Custom dashboard widget configuration
  formTemplates     Json?         @map("form_templates") // Custom form field configurations
  emailTemplates    Json?         @map("email_templates") // Email notification templates
  printStyles       Json?         @map("print_styles") // Print formatting preferences
  
  // Legal & Compliance
  termsOfService    String?       @map("terms_of_service")
  privacyPolicy     String?       @map("privacy_policy")
  consentForms      Json?         @map("consent_forms")
  
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  
  organization      Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("organization_settings")
}

model User {
  id                    String              @id @default(uuid())
  organizationId        String              @map("organization_id")
  azureAdId             String              @map("azure_ad_id")
  email                 String
  password              String
  firstName             String              @map("first_name")
  lastName              String              @map("last_name")
  role                  String
  phone                 String?
  isLandlord            Boolean             @default(false) @map("is_landlord")
  isActive              Boolean             @default(true) @map("is_active")
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  
  organization          Organization        @relation(fields: [organizationId], references: [id])
  serviceSessions       ServiceSession[]
  progressNotes         ProgressNote[]
  incidentReports       IncidentReport[]
  approvedNotes         ProgressNote[]      @relation("ApprovedByUser")
  reviewedIncidents     IncidentReport[]    @relation("ReviewedByUser")
  digitalSignatures     DigitalSignature[]
  auditLogs             AuditLog[]
  teamsNotifications    TeamsNotification[]
  formResponses         FormResponse[]      @relation("FormResponseUser")
  ispActivities         IspActivity[]
  tasksAssigned         Task[]              @relation("TaskAssignee")
  tasksCreated          Task[]              @relation("TaskAssigner")
  taskResultsVerified   TaskResult[]        @relation("TaskResultVerifier")
  violations            Violation[]         @relation("ViolationUser")
  violationsReported    Violation[]         @relation("ViolationReporter")
  violationsResolved    Violation[]         @relation("ViolationResolver")
  schedules             Schedule[]          @relation("ScheduleUser")
  schedulesCreated      Schedule[]          @relation("ScheduleCreator")
  appointmentRequests   AppointmentRequest[] @relation("AppointmentRequester")
  appointmentReviews    AppointmentRequest[] @relation("AppointmentReviewer")
  appointmentsAssigned  AppointmentRequest[] @relation("AppointmentDSP")
  dspAvailability       DspAvailability[]    @relation("DspAvailability")
  dspTimeOff            DspTimeOff[]         @relation("DspTimeOff")
  ticketsReported       SupportTicket[]     @relation("TicketReporter")
  ticketsAssigned       SupportTicket[]     @relation("TicketAssignee")
  ticketComments        TicketComment[]
  notifications         Notification[]
  notificationPreference NotificationPreference?

  @@unique([email, organizationId])
  @@unique([azureAdId, organizationId])
  @@index([organizationId])
  @@map("users")
}

model Client {
  id                      String              @id @default(uuid())
  organizationId          String              @map("organization_id")
  firstName               String              @map("first_name")
  lastName                String              @map("last_name")
  dateOfBirth             DateTime?           @map("date_of_birth") @db.Date
  dddId                   String?             @map("ddd_id")
  address                 String?
  latitude                Float?              // GPS latitude for location verification
  longitude               Float?              // GPS longitude for location verification
  locationAddress         String?             @map("location_address") // Formatted address
  locationRadiusMeters    Int?                @default(100) @map("location_radius_meters") // Acceptable radius for clock in
  emergencyContactName    String?             @map("emergency_contact_name")
  emergencyContactPhone   String?             @map("emergency_contact_phone")
  photoUrl                String?             @map("photo_url")
  isActive                Boolean             @default(true) @map("is_active")
  createdAt               DateTime            @default(now()) @map("created_at")
  updatedAt               DateTime            @updatedAt @map("updated_at")
  
  organization            Organization        @relation(fields: [organizationId], references: [id])
  ispOutcomes             IspOutcome[]
  serviceSessions         ServiceSession[]
  progressNotes           ProgressNote[]
  incidentReports         IncidentReport[]
  tasks                   Task[]
  violations              Violation[]
  schedules               Schedule[]
  appointmentRequests     AppointmentRequest[]
  dspAssignments          ClientDspAssignment[]

  @@unique([dddId, organizationId])
  @@index([organizationId])
  @@map("clients")
}

// DSP-Manager Assignment System (Admins assign DSPs to Managers)
model DspManagerAssignment {
  id                String          @id @default(uuid())
  dspId             String          @map("dsp_id")
  managerId         String          @map("manager_id")
  assignedBy        String          @map("assigned_by")
  startDate         DateTime        @default(now()) @map("start_date")
  endDate           DateTime?       @map("end_date")
  isActive          Boolean         @default(true) @map("is_active")
  notes             String?
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  
  @@index([dspId])
  @@index([managerId])
  @@index([isActive])
  @@map("dsp_manager_assignments")
}

// Client-DSP Assignment System (Managers assign Clients to DSPs)
model ClientDspAssignment {
  id                String          @id @default(uuid())
  clientId          String          @map("client_id")
  dspId             String          @map("dsp_id")
  assignedBy        String          @map("assigned_by")
  startDate         DateTime        @default(now()) @map("start_date")
  endDate           DateTime?       @map("end_date")
  isActive          Boolean         @default(true) @map("is_active")
  notes             String?
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  
  client            Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([clientId])
  @@index([dspId])
  @@index([isActive])
  @@map("client_dsp_assignments")
}

model IspOutcome {
  id                    String          @id @default(uuid())
  clientId              String          @map("client_id")
  outcomeDescription    String          @map("outcome_description")
  category              String?
  targetDate            DateTime?       @map("target_date") @db.Date
  status                String          @default("active")
  overallProgress       Int             @default(0) @map("overall_progress")
  lastReviewDate        DateTime?       @map("last_review_date")
  nextReviewDate        DateTime?       @map("next_review_date")
  reviewFrequency       String?         @map("review_frequency")
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")
  
  client                Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  progressNotes         ProgressNote[]
  goals                 IspGoal[]

  @@map("isp_outcomes")
}

model IspGoal {
  id                    String              @id @default(uuid())
  outcomeId             String              @map("outcome_id")
  title                 String
  description           String?
  goalType              String              @map("goal_type")
  measurementCriteria   Json?               @map("measurement_criteria")
  targetDate            DateTime?           @map("target_date")
  frequency             String?
  status                String              @default("active")
  priority              String              @default("medium")
  progressPercentage    Int                 @default(0) @map("progress_percentage")
  completedAt           DateTime?           @map("completed_at")
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  
  outcome               IspOutcome          @relation(fields: [outcomeId], references: [id], onDelete: Cascade)
  milestones            IspMilestone[]
  activities            IspActivity[]
  progressNotes         ProgressNote[]

  @@index([outcomeId])
  @@index([status])
  @@map("isp_goals")
}

model IspMilestone {
  id                    String              @id @default(uuid())
  goalId                String              @map("goal_id")
  title                 String
  description           String?
  targetDate            DateTime            @map("target_date")
  completionCriteria    String              @map("completion_criteria")
  status                String              @default("pending")
  achievedDate          DateTime?           @map("achieved_date")
  notes                 String?
  orderIndex            Int                 @default(1) @map("order_index")
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  
  goal                  IspGoal             @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@index([status])
  @@map("isp_milestones")
}

model IspActivity {
  id                    String              @id @default(uuid())
  goalId                String              @map("goal_id")
  progressNoteId        String?             @map("progress_note_id")
  staffId               String              @map("staff_id")
  activityDate          DateTime            @map("activity_date")
  activityType          String              @map("activity_type")
  description           String
  duration              Int?
  prompts               Json?
  successLevel          String?             @map("success_level")
  observations          String?
  barriers              String?
  modifications         String?
  progressRating        Int?                @map("progress_rating")
  createdAt             DateTime            @default(now()) @map("created_at")
  
  goal                  IspGoal             @relation(fields: [goalId], references: [id], onDelete: Cascade)
  progressNote          ProgressNote?       @relation(fields: [progressNoteId], references: [id])
  staff                 User                @relation(fields: [staffId], references: [id])

  @@index([goalId])
  @@index([staffId])
  @@index([activityDate])
  @@map("isp_activities")
}

model ServiceSession {
  id                  String          @id @default(uuid())
  staffId             String          @map("staff_id")
  clientId            String          @map("client_id")
  serviceType         String          @map("service_type")
  clockInTime         DateTime        @map("clock_in_time")
  clockInLat          Float?          @map("clock_in_lat")
  clockInLng          Float?          @map("clock_in_lng")
  clockOutTime        DateTime?       @map("clock_out_time")
  clockOutLat         Float?          @map("clock_out_lat")
  clockOutLng         Float?          @map("clock_out_lng")
  totalHours          Float?          @map("total_hours")
  locationName        String?         @map("location_name")
  locationVerified    Boolean?        @default(false) @map("location_verified") // Was location within range?
  distanceFromClient  Int?            @map("distance_from_client") // Distance in meters
  verificationMessage String?         @map("verification_message") // Verification status message
  status              String          @default("in_progress")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  
  staff               User            @relation(fields: [staffId], references: [id])
  client              Client          @relation(fields: [clientId], references: [id])
  progressNotes       ProgressNote[]

  @@index([staffId])
  @@index([clientId])
  @@map("service_sessions")
}

model ProgressNote {
  id                    String                      @id @default(uuid())
  sessionId             String?                     @map("session_id")
  clientId              String                      @map("client_id")
  staffId               String                      @map("staff_id")
  serviceType           String                      @map("service_type")
  serviceDate           DateTime                    @map("service_date") @db.Date
  startTime             DateTime                    @map("start_time") @db.Time(6)
  endTime               DateTime                    @map("end_time") @db.Time(6)
  location              String?
  ispOutcomeId          String?                     @map("isp_outcome_id")
  ispGoalId             String?                     @map("isp_goal_id")
  reasonForService      String?                     @map("reason_for_service")
  supportsProvided      String?                     @map("supports_provided")
  individualResponse    Json?                       @map("individual_response")
  progressAssessment    String?                     @map("progress_assessment")
  progressNotes         String?                     @map("progress_notes")
  safetyDignityNotes    String?                     @map("safety_dignity_notes")
  nextSteps             String?                     @map("next_steps")
  status                String                      @default("draft")
  submittedAt           DateTime?                   @map("submitted_at")
  approvedBy            String?                     @map("approved_by")
  approvedAt            DateTime?                   @map("approved_at")
  rejectionReason       String?                     @map("rejection_reason")
  sharepointUrl         String?                     @map("sharepoint_url")
  pdfUrl                String?                     @map("pdf_url")
  createdAt             DateTime                    @default(now()) @map("created_at")
  updatedAt             DateTime                    @updatedAt @map("updated_at")
  
  session               ServiceSession?             @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  client                Client                      @relation(fields: [clientId], references: [id])
  staff                 User                        @relation(fields: [staffId], references: [id])
  ispOutcome            IspOutcome?                 @relation(fields: [ispOutcomeId], references: [id])
  ispGoal               IspGoal?                    @relation(fields: [ispGoalId], references: [id])
  approver              User?                       @relation("ApprovedByUser", fields: [approvedBy], references: [id])
  activities            ProgressNoteActivity[]
  ispActivities         IspActivity[]
  mediaAttachments      MediaAttachment[]
  digitalSignatures     DigitalSignature[]
  teamsNotifications    TeamsNotification[]

  @@index([status])
  @@index([clientId])
  @@index([staffId])
  @@map("progress_notes")
}

model ProgressNoteActivity {
  id                    String          @id @default(uuid())
  progressNoteId        String          @map("progress_note_id")
  activityNumber        Int             @map("activity_number")
  taskGoal              String          @map("task_goal")
  supportsProvided      String?         @map("supports_provided")
  promptLevel           String[]        @map("prompt_level")
  objectiveObservation  String?         @map("objective_observation")
  createdAt             DateTime        @default(now()) @map("created_at")
  
  progressNote          ProgressNote    @relation(fields: [progressNoteId], references: [id], onDelete: Cascade)

  @@map("progress_note_activities")
}

model MediaAttachment {
  id                  String            @id @default(uuid())
  progressNoteId      String?           @map("progress_note_id")
  incidentReportId    String?           @map("incident_report_id")
  fileType            String            @map("file_type")
  fileUrl             String            @map("file_url")
  azureBlobPath       String?           @map("azure_blob_path")
  thumbnailUrl        String?           @map("thumbnail_url")
  fileSizeBytes       BigInt?           @map("file_size_bytes")
  durationSeconds     Int?              @map("duration_seconds")
  transcription       String?
  caption             String?
  createdAt           DateTime          @default(now()) @map("created_at")
  
  progressNote        ProgressNote?     @relation(fields: [progressNoteId], references: [id], onDelete: Cascade)
  incidentReport      IncidentReport?   @relation(fields: [incidentReportId], references: [id], onDelete: Cascade)

  @@map("media_attachments")
}

model IncidentReport {
  id                  String              @id @default(uuid())
  clientId            String              @map("client_id")
  staffId             String              @map("staff_id")
  incidentDate        DateTime            @map("incident_date") @db.Date
  incidentTime        DateTime            @map("incident_time") @db.Time(6)
  location            String?
  locationLat         Float?              @map("location_lat")
  locationLng         Float?              @map("location_lng")
  employeeStatement   String?             @map("employee_statement")
  clientStatement     String?             @map("client_statement")
  actionTaken         String?             @map("action_taken")
  severity            String
  incidentType        String              @map("incident_type")
  status              String              @default("open")
  submittedAt         DateTime            @default(now()) @map("submitted_at")
  reviewedBy          String?             @map("reviewed_by")
  reviewedAt          DateTime?           @map("reviewed_at")
  sharepointUrl       String?             @map("sharepoint_url")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  
  client              Client              @relation(fields: [clientId], references: [id])
  staff               User                @relation(fields: [staffId], references: [id])
  reviewer            User?               @relation("ReviewedByUser", fields: [reviewedBy], references: [id])
  mediaAttachments    MediaAttachment[]
  digitalSignatures   DigitalSignature[]
  teamsNotifications  TeamsNotification[]

  @@index([status])
  @@index([severity])
  @@map("incident_reports")
}

model DigitalSignature {
  id                  String            @id @default(uuid())
  progressNoteId      String?           @map("progress_note_id")
  incidentReportId    String?           @map("incident_report_id")
  userId              String            @map("user_id")
  signatureType       String            @map("signature_type")
  signatureData       String            @map("signature_data")
  signedAt            DateTime          @default(now()) @map("signed_at")
  ipAddress           String?           @map("ip_address")
  deviceInfo          String?           @map("device_info")
  
  progressNote        ProgressNote?     @relation(fields: [progressNoteId], references: [id], onDelete: Cascade)
  incidentReport      IncidentReport?   @relation(fields: [incidentReportId], references: [id], onDelete: Cascade)
  user                User              @relation(fields: [userId], references: [id])

  @@map("digital_signatures")
}

model AuditLog {
  id              String        @id @default(uuid())
  organizationId  String?       @map("organization_id")
  userId          String?       @map("user_id")
  action          String
  entityType      String?       @map("entity_type")
  entityId        String?       @map("entity_id")
  changes         Json?
  ipAddress       String?       @map("ip_address")
  userAgent       String?       @map("user_agent")
  createdAt       DateTime      @default(now()) @map("created_at")
  
  organization    Organization? @relation(fields: [organizationId], references: [id])
  user            User?         @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@map("audit_logs")
}

model TeamsNotification {
  id                  String            @id @default(uuid())
  progressNoteId      String?           @map("progress_note_id")
  incidentReportId    String?           @map("incident_report_id")
  recipientUserId     String?           @map("recipient_user_id")
  notificationType    String            @map("notification_type")
  teamsMessageId      String?           @map("teams_message_id")
  adaptiveCardJson    Json?             @map("adaptive_card_json")
  sentAt              DateTime          @default(now()) @map("sent_at")
  actionTaken         String?           @map("action_taken")
  actionTakenAt       DateTime?         @map("action_taken_at")
  
  progressNote        ProgressNote?     @relation(fields: [progressNoteId], references: [id])
  incidentReport      IncidentReport?   @relation(fields: [incidentReportId], references: [id])
  recipientUser       User?             @relation(fields: [recipientUserId], references: [id])

  @@map("teams_notifications")
}

// Survey/Form Template System
model FormTemplate {
  id                String          @id @default(uuid())
  organizationId    String          @map("organization_id")
  name              String
  description       String?
  formType          String          @map("form_type") // 'progress_note', 'incident_report'
  serviceType       String?         @map("service_type") // 'community_based_support', etc.
  isActive          Boolean         @default(true) @map("is_active")
  isDefault         Boolean         @default(false) @map("is_default")
  version           Int             @default(1)
  createdBy         String?         @map("created_by")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  
  organization      Organization    @relation(fields: [organizationId], references: [id])
  sections          FormSection[]
  responses         FormResponse[]

  @@index([organizationId])
  @@map("form_templates")
}

model FormSection {
  id                String          @id @default(uuid())
  templateId        String          @map("template_id")
  title             String
  description       String?
  orderIndex        Int             @map("order_index")
  isRepeatable      Boolean         @default(false) @map("is_repeatable") // Can add multiple instances
  maxRepeat         Int?            @map("max_repeat")
  isRequired        Boolean         @default(true) @map("is_required")
  
  template          FormTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  fields            FormField[]

  @@map("form_sections")
}

model FormField {
  id                String          @id @default(uuid())
  sectionId         String          @map("section_id")
  label             String
  fieldType         String          @map("field_type") // 'text', 'textarea', 'select', 'multiselect', 'checkbox', 'radio'
  orderIndex        Int             @map("order_index")
  isRequired        Boolean         @default(false) @map("is_required")
  options           Json?           // For select/radio/checkbox options
  validation        Json?           // Validation rules
  placeholder       String?
  helpText          String?         @map("help_text")
  defaultValue      String?         @map("default_value")
  
  section           FormSection     @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@map("form_fields")
}

model FormResponse {
  id                String          @id @default(uuid())
  templateId        String          @map("template_id")
  progressNoteId    String?         @map("progress_note_id")
  incidentReportId  String?         @map("incident_report_id")
  userId            String          @map("user_id")
  responseData      Json            @map("response_data") // Complete form response
  status            String          @default("draft") // 'draft', 'submitted', 'approved', 'rejected'
  submittedAt       DateTime?       @map("submitted_at")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  
  template          FormTemplate    @relation(fields: [templateId], references: [id])
  user              User            @relation("FormResponseUser", fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("form_responses")
}

// Task Management System
model Task {
  id                String          @id @default(uuid())
  organizationId    String          @map("organization_id")
  assignedTo        String          @map("assigned_to")
  assignedBy        String          @map("assigned_by")
  clientId          String?         @map("client_id")
  taskType          String          @map("task_type")
  title             String
  description       String?
  priority          String          @default("medium")
  status            String          @default("pending")
  dueDate           DateTime        @map("due_date")
  startedAt         DateTime?       @map("started_at")
  completedAt       DateTime?       @map("completed_at")
  estimatedHours    Float?          @map("estimated_hours")
  actualHours       Float?          @map("actual_hours")
  completionNotes   String?         @map("completion_notes")
  attachments       Json?
  reminders         Json?
  recurring         Boolean         @default(false)
  recurringPattern  String?         @map("recurring_pattern")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  
  assignee          User            @relation("TaskAssignee", fields: [assignedTo], references: [id])
  assigner          User            @relation("TaskAssigner", fields: [assignedBy], references: [id])
  client            Client?         @relation(fields: [clientId], references: [id])
  results           TaskResult[]
  checklistItems    TaskChecklist[]
  violations        Violation[]
  
  @@index([organizationId])
  @@index([assignedTo])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

model TaskResult {
  id                String          @id @default(uuid())
  taskId            String          @map("task_id")
  resultType        String          @map("result_type")
  description       String
  metrics           Json?
  evidence          Json?
  verifiedBy        String?         @map("verified_by")
  verifiedAt        DateTime?       @map("verified_at")
  notes             String?
  createdAt         DateTime        @default(now()) @map("created_at")
  
  task              Task            @relation(fields: [taskId], references: [id], onDelete: Cascade)
  verifier          User?           @relation("TaskResultVerifier", fields: [verifiedBy], references: [id])
  
  @@index([taskId])
  @@map("task_results")
}

model TaskChecklist {
  id                String          @id @default(uuid())
  taskId            String          @map("task_id")
  title             String
  isCompleted       Boolean         @default(false) @map("is_completed")
  completedAt       DateTime?       @map("completed_at")
  orderIndex        Int             @default(1) @map("order_index")
  
  task              Task            @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@map("task_checklist")
}

model Violation {
  id                String          @id @default(uuid())
  organizationId    String          @map("organization_id")
  userId            String          @map("user_id")
  reportedBy        String          @map("reported_by")
  violationType     String          @map("violation_type")
  severity          String
  status            String          @default("open")
  incidentDate      DateTime        @map("incident_date")
  description       String
  evidence          Json?
  clientId          String?         @map("client_id")
  taskId            String?         @map("task_id")
  correctiveAction  String?         @map("corrective_action")
  resolution        String?
  resolvedBy        String?         @map("resolved_by")
  resolvedAt        DateTime?       @map("resolved_at")
  points            Int             @default(0)
  isAppealed        Boolean         @default(false) @map("is_appealed")
  appealNotes       String?         @map("appeal_notes")
  appealResolvedBy  String?         @map("appeal_resolved_by")
  appealResolvedAt  DateTime?       @map("appeal_resolved_at")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  
  violator          User            @relation("ViolationUser", fields: [userId], references: [id])
  reporter          User            @relation("ViolationReporter", fields: [reportedBy], references: [id])
  resolver          User?           @relation("ViolationResolver", fields: [resolvedBy], references: [id])
  client            Client?         @relation(fields: [clientId], references: [id])
  task              Task?           @relation(fields: [taskId], references: [id])
  
  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([severity])
  @@map("violations")
}

model ServiceStrategy {
  id                String          @id @default(uuid())
  organizationId    String          @map("organization_id")
  category          String
  name              String
  description       String?
  isActive          Boolean         @default(true) @map("is_active")
  orderIndex        Int             @default(1) @map("order_index")
  createdAt         DateTime        @default(now()) @map("created_at")
  
  @@index([organizationId])
  @@index([category])
  @@map("service_strategies")
}

// Scheduling System
model Schedule {
  id                String                @id @default(uuid())
  organizationId    String                @map("organization_id")
  userId            String                @map("user_id")
  clientId          String?               @map("client_id")
  title             String
  shiftType         String                @map("shift_type") // 'work', 'training', 'meeting', 'time_off'
  startTime         DateTime              @map("start_time")
  endTime           DateTime              @map("end_time")
  isAllDay          Boolean               @default(false) @map("is_all_day")
  location          String?
  notes             String?
  status            String                @default("scheduled") // 'scheduled', 'completed', 'cancelled'
  recurrence        String?               // 'daily', 'weekly', 'biweekly', 'monthly'
  recurrenceEnd     DateTime?             @map("recurrence_end")
  color             String?
  createdBy         String                @map("created_by")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")
  
  user              User                  @relation("ScheduleUser", fields: [userId], references: [id])
  client            Client?               @relation(fields: [clientId], references: [id])
  creator           User                  @relation("ScheduleCreator", fields: [createdBy], references: [id])
  appointmentRequest AppointmentRequest?  @relation("ScheduleAppointment")
  
  @@index([organizationId])
  @@index([userId])
  @@index([startTime])
  @@index([endTime])
  @@map("schedules")
}

// Appointment Request System
model AppointmentRequest {
  id                String          @id @default(uuid())
  organizationId    String          @map("organization_id")
  clientId          String          @map("client_id")
  requestedBy       String          @map("requested_by")
  appointmentType   String          @map("appointment_type") // 'medical', 'therapy', 'social', 'dental', etc.
  urgency           String          @default("routine") // 'routine', 'urgent', 'emergency'
  reason            String
  notes             String?
  preferredDates    Json            @map("preferred_dates") // Array of date options
  preferredTimes    Json?           @map("preferred_times") // Time preferences
  location          String?
  provider          String?         // Doctor/therapist name
  providerPhone     String?         @map("provider_phone")
  transportation    String?         // 'self', 'family', 'needs_transport'
  status            String          @default("pending") // 'pending', 'approved', 'rejected', 'scheduled', 'cancelled'
  reviewedBy        String?         @map("reviewed_by")
  reviewedAt        DateTime?       @map("reviewed_at")
  reviewNotes       String?         @map("review_notes")
  scheduledDate     DateTime?       @map("scheduled_date")
  scheduleId        String?         @unique @map("schedule_id")
  
  // NEW: Enhanced appointment fields
  assignedDspId           String?   @map("assigned_dsp_id")
  estimatedDuration       Int       @default(60) @map("estimated_duration") // minutes
  actualDuration          Int?      @map("actual_duration")
  checkInTime             DateTime? @map("check_in_time")
  checkOutTime            DateTime? @map("check_out_time")
  transportationRequired  Boolean   @default(false) @map("transportation_required")
  transportationAssignedTo String?  @map("transportation_assigned_to")
  reminderSent            Boolean   @default(false) @map("reminder_sent")
  reminderSentAt          DateTime? @map("reminder_sent_at")
  followUpRequired        Boolean   @default(false) @map("follow_up_required")
  followUpNotes           String?   @map("follow_up_notes")
  recurringGroupId        String?   @map("recurring_group_id")
  isRecurring             Boolean   @default(false) @map("is_recurring")
  recurringRule           Json?     @map("recurring_rule")
  reminderSettings        Json?     @map("reminder_settings")
  
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  
  client            Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  requester         User            @relation("AppointmentRequester", fields: [requestedBy], references: [id])
  reviewer          User?           @relation("AppointmentReviewer", fields: [reviewedBy], references: [id])
  assignedDsp       User?           @relation("AppointmentDSP", fields: [assignedDspId], references: [id])
  schedule          Schedule?       @relation("ScheduleAppointment", fields: [scheduleId], references: [id])
  reminders         AppointmentReminder[]
  
  @@index([organizationId])
  @@index([clientId])
  @@index([requestedBy])
  @@index([status])
  @@index([urgency])
  @@index([assignedDspId, scheduledDate])
  @@index([recurringGroupId])
  @@map("appointment_requests")
}

// DSP Availability Management
model DspAvailability {
  id            String    @id @default(uuid())
  dspId         String    @map("dsp_id")
  dayOfWeek     Int       @map("day_of_week") // 0 = Sunday, 6 = Saturday
  startTime     String    @map("start_time")  // "09:00"
  endTime       String    @map("end_time")    // "17:00"
  isAvailable   Boolean   @default(true) @map("is_available")
  effectiveFrom DateTime? @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")
  createdAt     DateTime  @default(now()) @map("created_at")
  
  dsp           User      @relation("DspAvailability", fields: [dspId], references: [id], onDelete: Cascade)
  
  @@index([dspId])
  @@index([dayOfWeek])
  @@map("dsp_availability")
}

// DSP Time Off Requests
model DspTimeOff {
  id          String    @id @default(uuid())
  dspId       String    @map("dsp_id")
  startDate   DateTime  @map("start_date")
  endDate     DateTime  @map("end_date")
  reason      String?
  approved    Boolean   @default(false)
  approvedBy  String?   @map("approved_by")
  approvedAt  DateTime? @map("approved_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  dsp         User      @relation("DspTimeOff", fields: [dspId], references: [id], onDelete: Cascade)
  
  @@index([dspId])
  @@index([startDate, endDate])
  @@map("dsp_time_off")
}

// Appointment Reminders
model AppointmentReminder {
  id            String    @id @default(uuid())
  appointmentId String    @map("appointment_id")
  reminderType  String    @map("reminder_type") // 'client', 'dsp', 'manager'
  scheduledFor  DateTime  @map("scheduled_for")
  sent          Boolean   @default(false)
  sentAt        DateTime? @map("sent_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  
  appointment   AppointmentRequest @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  @@index([appointmentId])
  @@index([scheduledFor, sent])
  @@map("appointment_reminders")
}

// Support Ticket System
model SupportTicket {
  id                String              @id @default(uuid())
  organizationId    String              @map("organization_id")
  title             String
  description       String
  priority          String              @default("medium") // 'low', 'medium', 'high', 'critical'
  status            String              @default("open") // 'open', 'in_progress', 'resolved', 'closed'
  category          String              // 'technical', 'billing', 'feature_request', 'other'
  reportedBy        String              @map("reported_by")
  assignedTo        String?             @map("assigned_to")
  resolution        String?
  attachments       Json?
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  resolvedAt        DateTime?           @map("resolved_at")
  
  organization      Organization        @relation(fields: [organizationId], references: [id])
  reporter          User                @relation("TicketReporter", fields: [reportedBy], references: [id])
  assignee          User?               @relation("TicketAssignee", fields: [assignedTo], references: [id])
  comments          TicketComment[]
  
  @@index([organizationId])
  @@index([status])
  @@index([priority])
  @@map("support_tickets")
}

model TicketComment {
  id                String              @id @default(uuid())
  ticketId          String              @map("ticket_id")
  userId            String              @map("user_id")
  comment           String
  isInternal        Boolean             @default(false) @map("is_internal") // Only visible to admins
  createdAt         DateTime            @default(now()) @map("created_at")
  
  ticket            SupportTicket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id])
  
  @@index([ticketId])
  @@map("ticket_comments")
}

model UsageMetric {
  id                String              @id @default(uuid())
  organizationId    String              @map("organization_id")
  metricType        String              @map("metric_type") // 'users', 'clients', 'sessions', 'storage_mb', 'api_calls'
  value             Int
  recordedAt        DateTime            @default(now()) @map("recorded_at")
  
  organization      Organization        @relation(fields: [organizationId], references: [id])
  
  @@index([organizationId])
  @@index([metricType])
  @@index([recordedAt])
  @@map("usage_metrics")
}

// Notification System
model Notification {
  id                String              @id @default(uuid())
  organizationId    String              @map("organization_id")
  userId            String              @map("user_id") // Recipient
  type              String              // 'appointment_request', 'ticket_update', 'task_assigned', etc.
  title             String
  message           String
  actionUrl         String?             @map("action_url") // Where to navigate when clicked
  actionLabel       String?             @map("action_label") // Button text
  relatedId         String?             @map("related_id") // ID of related resource
  relatedType       String?             @map("related_type") // Type of related resource
  isRead            Boolean             @default(false) @map("is_read")
  isEmailed         Boolean             @default(false) @map("is_emailed")
  priority          String              @default("normal") // 'low', 'normal', 'high', 'urgent'
  metadata          Json?               // Additional context
  createdAt         DateTime            @default(now()) @map("created_at")
  readAt            DateTime?           @map("read_at")
  
  organization      Organization        @relation(fields: [organizationId], references: [id])
  user              User                @relation(fields: [userId], references: [id])
  
  @@index([userId, isRead])
  @@index([organizationId])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id                    String          @id @default(uuid())
  userId                String          @unique @map("user_id")
  
  // Notification channels
  emailEnabled          Boolean         @default(true) @map("email_enabled")
  inAppEnabled          Boolean         @default(true) @map("in_app_enabled")
  
  // Event types
  appointmentRequests   Boolean         @default(true) @map("appointment_requests")
  appointmentApprovals  Boolean         @default(true) @map("appointment_approvals")
  taskAssignments       Boolean         @default(true) @map("task_assignments")
  scheduleChanges       Boolean         @default(true) @map("schedule_changes")
  incidentReports       Boolean         @default(true) @map("incident_reports")
  ticketUpdates         Boolean         @default(true) @map("ticket_updates")
  violationAlerts       Boolean         @default(true) @map("violation_alerts")
  systemAnnouncements   Boolean         @default(true) @map("system_announcements")
  
  // Timing
  quietHoursStart       String?         @map("quiet_hours_start") // "22:00"
  quietHoursEnd         String?         @map("quiet_hours_end") // "08:00"
  digestFrequency       String          @default("never") @map("digest_frequency") // 'never', 'daily', 'weekly'
  
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")
  
  user                  User            @relation(fields: [userId], references: [id])
  
  @@map("notification_preferences")
}
